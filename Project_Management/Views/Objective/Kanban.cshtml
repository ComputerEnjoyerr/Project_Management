@model List<Project_Management.Models.Objective>
@using Microsoft.AspNetCore.Antiforgery
@inject IAntiforgery Antiforgery

@{
    ViewBag.Title = "Kanban - " + ViewBag.ProjectName;
    Layout = "~/Views/Shared/_Home.cshtml";
    var statuses = new[] {
        new { Name = "Todo", Color = "bg-secondary"},
        new { Name = "InProgress", Color = "bg-primary"},
        new { Name = "Review", Color = "bg-warning"},
        new { Name = "Done", Color = "bg-success"}
    };

    var project = ViewBag.Project as Project_Management.Models.Project;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">@(project?.Name ?? "Project")</h1>
                    <p class="text-muted mb-0">@(project?.Description ?? "Chưa có mô tả")</p>

                </div>

                <div class="text-end">
                    <span class="badge bg-light text-dark fs-6">
                        <i class="fas fa-tasks me-1"></i>
                        @Model.Count Công việc
                    </span>
                    <div class="mt-1">
                        <small class="text-muted">
                            Cập nhật lần cuối: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="row kanban-board">
        @foreach (var status in statuses)
        {
            var tasksInStatus = Model.Where(o => o.Status == status.Name).ToList();
            var taskCount = tasksInStatus.Count;

            <div class="col-xl-3 col-lg-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header @status.Color text-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold fs-6">@status.Name</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body kanban-column p-3" data-status="@status.Name"
                         style="min-height: 500px; background-color: #f8f9fa;">

                        @if (tasksInStatus.Any())
                        {
                            foreach (var task in tasksInStatus)
                            {
                                <div class="kanban-item card mb-3 border-0 shadow-sm"
                                     draggable="true"
                                     data-id="@task.ObjectiveId"
                                     style="cursor: grab; transition: all 0.3s ease;">
                                    <div class="card-body p-3">
                                        <!-- Due Date on top -->
                                        @if (task.DueDate.HasValue)
                                        {
                                            var dueSoon = task.DueDate.Value <= DateOnly.FromDateTime(DateTime.Now.AddDays(3));
                                            <div class="mb-2">
                                                <small class="@(dueSoon ? "text-warning fw-bold" : "text-muted") fst-bold">
                                                    Hạn chót: @task.DueDate.Value.ToString("dd/MM/yyyy")
                                                </small>
                                            </div>
                                        }

                                        <!-- Full task title without truncation -->
                                        <div class="fw-bold mb-2" style="word-wrap: break-word; white-space: normal;">
                                            @task.Title
                                        </div>

                                        <!-- Assigned person -->
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                @if (!string.IsNullOrEmpty(task.AssignedToEmail))
                                                {
                                                    <span>@task.AssignedToEmail</span>
                                                }
                                                else
                                                {
                                                    <span class="text-warning">Unassigned</span>
                                                }
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            @* <div class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p class="small">Chưa có công việc trong @status.Name</p>
                            </div> *@
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Quay lại trang chi tiết để tạo Dự án, Công việc</small>
                        </div>
                        <div>
                            <a asp-action="Detail" asp-controller="Home" asp-route-id="@project.ProjectId" class="btn btn-sm btn-outline-secondary">
                                Quay lại
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .kanban-column {
        transition: background-color 0.3s ease;
    }

        .kanban-column.drag-over {
            background-color: #e3f2fd !important;
            border: 2px dashed #2196F3;
        }

    .kanban-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .kanban-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }

        .kanban-item:active {
            cursor: grabbing;
        }

        /* Ensure cards have consistent height and content displays properly */
        .kanban-item .card-body {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
</style>

<script>
    const antiforgeryToken = '@Antiforgery.GetAndStoreTokens(Context).RequestToken';

    // Initialize drag and drop
    document.querySelectorAll('.kanban-item').forEach(item => {
        item.addEventListener('dragstart', e => {
            e.dataTransfer.setData('id', e.target.dataset.id);
            e.target.style.opacity = '0.6';
        });

        item.addEventListener('dragend', e => {
            e.target.style.opacity = '1';
        });
    });

    document.querySelectorAll('.kanban-column').forEach(col => {
        col.addEventListener('dragover', e => {
            e.preventDefault();
            col.classList.add('drag-over');
        });

        col.addEventListener('dragleave', e => {
            e.preventDefault();
            col.classList.remove('drag-over');
        });

        col.addEventListener('drop', async e => {
            e.preventDefault();
            col.classList.remove('drag-over');

            const id = e.dataTransfer.getData('id');
            const newStatus = col.dataset.status;
            const item = document.querySelector(`[data-id="${id}"]`);

            if (item && col !== item.parentElement) {
                // Add animation
                item.style.transform = 'scale(0.95)';

                // Move item in UI
                col.appendChild(item);

                // Restore animation
                setTimeout(() => {
                    item.style.transform = 'scale(1)';
                }, 150);

                // Update server
                try {
                    const response = await fetch(`/Objective/UpdateStatus?id=${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': antiforgeryToken
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error('Update failed');
                    }

                    // Update counters
                    updateTaskCounters();

                } catch (error) {
                    console.error('Error updating task:', error);
                    // Could revert the UI change here if needed
                }
            }
        });
    });

    // Update task counters
    function updateTaskCounters() {
        // Simple notification
        showNotification('Task status updated successfully!', 'success');
    }

    // Simple notification function
    function showNotification(message, type) {
        // You can integrate with a toast library here
        console.log(`${type}: ${message}`);

        // Simple browser notification
        if (type === 'success') {
            // Optional: Add a subtle visual feedback
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
    }
</script>