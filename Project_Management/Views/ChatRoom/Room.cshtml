@* @model List<Project_Management.Models.Message>

@{
    Layout = null;
    var chatRoomId = ViewBag.ChatRoomId;
    var user = ViewBag.UserEmail;
}

<div id="chatBox" style="height:60vh; overflow-y:auto; background:#f7f7f7; padding:10px;">
    @foreach (var m in Model)
    {
        @if (m.SenderEmail == user)
        {
            <div class="mb-2 text-end">
                <span class="text-muted small">@m.SentAt?.ToString("HH:mm")</span>
                <strong>@m.SenderEmail</strong>
                <div>@m.Content</div>
            </div>
        } else
        {
            <div class="mb-2">
                <strong>@m.SenderEmail</strong>
                <span class="text-muted small">@m.SentAt?.ToString("HH:mm")</span>
                <div>@m.Content</div>
            </div>
        }
    }
</div>

<div class="input-group mt-3">
    <input id="msg" type="text" class="form-control" placeholder="Nhập tin nhắn..." />
    <button id="send" class="btn btn-primary">Gửi</button>
</div>

<script src="~/lib/signalr/signalr.js"></script>

<script>
    const chatRoomId = '@chatRoomId';
    const user = '@user';

    const conn = new signalR.HubConnectionBuilder()
        .withUrl(`/chatHub?chatRoomId=${chatRoomId}`)
        .build();

    conn.on("ReceiveMessage", (u, content, time) => {
        const box = document.getElementById("chatBox");
        box.innerHTML += `<div class="mb-2">
                            <strong>${u}</strong>
                            <span class="text-muted small">${time}</span>
                            <div>${content}</div>
                          </div>`;
        box.scrollTop = box.scrollHeight;
    });

    conn.start();

    document.getElementById("send").onclick = send;
    document.getElementById("msg").onkeypress = e => {
        if (e.key === "Enter") send();
    };

    // function send() {
    //     const content = document.getElementById("msg").value;
    //     if (!content.trim()) return;

    //     conn.invoke("SendMessage", chatRoomId, user, content);

    //     fetch("/ChatRoom/SendMessage", {
    //         method: "POST",
    //         headers: { "Content-Type": "application/x-www-form-urlencoded" },
    //         body: `chatRoomId=${chatRoomId}&content=${content}`
    //     });

    //     document.getElementById("msg").value = "";
    // }
</script>

<style>
    .hover-bg:hover {
        background-color: #f8f9fa;
        cursor: pointer;
        border-radius: 8px;
    }

    .active-item {
        background-color: #e3f2fd !important;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
    }

    .truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80%;
    }

    #messageBox {
        scroll-behavior: smooth;
        background: radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.03) 0%, transparent 50%);
    }

    .message-item {
        transition: all 0.2s ease;
    }

        .message-item:hover {
            transform: translateX(2px);
        }

    /* Custom scrollbar */
    #projectList::-webkit-scrollbar,
    #chatRoomList::-webkit-scrollbar,
    #messageBox::-webkit-scrollbar {
        width: 6px;
    }

    #projectList::-webkit-scrollbar-track,
    #chatRoomList::-webkit-scrollbar-track,
    #messageBox::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #projectList::-webkit-scrollbar-thumb,
    #chatRoomList::-webkit-scrollbar-thumb,
    #messageBox::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

        #projectList::-webkit-scrollbar-thumb:hover,
        #chatRoomList::-webkit-scrollbar-thumb:hover,
        #messageBox::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
</style> *@